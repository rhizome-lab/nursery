# Tool Registry Spec

Specification for cross-platform package resolution using Repology.

## Overview

myenv uses [Repology](https://repology.org) to resolve tool names to package names across different ecosystems (apt, pacman, nix, brew, etc.). Repology is a comprehensive package tracking service that monitors 300+ package repositories.

## Why Repology?

Instead of building and maintaining our own registry, we leverage Repology's existing infrastructure:

- **Comprehensive coverage**: 300+ repos already tracked
- **Community maintained**: Package mappings updated automatically
- **Battle-tested**: Used by package maintainers worldwide
- **API available**: JSON API for programmatic access

## Repology API

### Endpoint

```
GET https://repology.org/api/v1/project/{name}
```

Returns an array of packages across all repositories that belong to the project.

### Response Fields

| Field | Description |
|-------|-------------|
| `repo` | Repository name (e.g., "arch", "debian_12", "homebrew") |
| `visiblename` | Package name to install |
| `binname` | Binary name (executable) |
| `version` | Version string |
| `status` | "newest", "outdated", "legacy", etc. |

### Rate Limiting

- 1 request/second for bulk operations
- Local caching recommended (24h TTL)

## Ecosystem Mapping

Repology uses specific repo identifiers. We map them to our ecosystem enum:

| Ecosystem | Repology Repos |
|-----------|----------------|
| `pacman` | `arch`, `aur` |
| `apt` | `debian_*`, `ubuntu_*` |
| `dnf` | `fedora_*`, `centos_*`, `epel_*` |
| `apk` | `alpine_*` |
| `brew` | `homebrew`, `homebrew_casks` |
| `nix` | `nix_*` |
| `scoop` | `scoop` |
| `winget` | `winget` |
| `cargo` | `crates_io` |

## Caching

Results are cached locally in `~/.cache/myenv/repology/`:

```
~/.cache/myenv/repology/
  ripgrep.json      # Cached ToolInfo
  fd-find.json
  ...
```

Cache TTL: 24 hours

## myenv.toml

```toml
[project]
name = "my-project"
version = "0.1.0"

[tools]
ripgrep = ">=14"
fd-find = "*"      # Note: Repology project name
jq = "=1.7"

# Optional: limit ecosystems in lockfile
ecosystems = ["pacman", "nix"]
```

**Important**: Tool names must match Repology project names. Use `myenv tools lookup <name>` to find the correct project name.

## myenv.lock

Generated by `myenv tools lock`:

```toml
[ripgrep]
source = "repology:ripgrep"
constraint = ">=14"

[ripgrep.pacman]
package = "ripgrep"
version = "14.1.0"

[ripgrep.apt]
package = "rust-ripgrep"
version = "14.1.0"

[ripgrep.nix]
package = "ripgrep"
version = "14.1.0"
```

## Commands

### `myenv tools lookup <name>`

Look up a tool via Repology:

```
$ myenv tools lookup ripgrep
Looking up 'ripgrep' via Repology...

Binary: ripgrep
Packages:
  pacman       ripgrep (14.1.0)
  apt          rust-ripgrep (14.1.0)
  nix          ripgrep (14.1.0)
  brew         ripgrep (14.1.0)
  cargo        ripgrep (14.1.0)
```

### `myenv tools lock`

Resolve all tool dependencies and write lockfile:

```
$ myenv tools lock
Resolving tools for ecosystems: pacman, nix

  ripgrep... ok (2 ecosystem(s))
  fd-find... ok (2 ecosystem(s))

Wrote myenv.lock
Locked 2 tool(s)
```

### `myenv tools check`

Verify installed tools:

```
$ myenv tools check
  ripgrep: OK
  fd-find: MISSING

missing 1 required tool(s)
run 'myenv tools install' to install them
```

### `myenv tools install`

Install missing tools:

```
$ myenv tools install

Missing tools for pacman:
  fd

Run this command?

  sudo pacman -S fd

[Y/n]
```

## Known Limitations

### Project Name Mismatches

Some tools have different Repology project names than their common names:

| Common Name | Repology Name |
|-------------|---------------|
| `fd` | `fd-find` |
| `bat` | `bat-cat` (sometimes) |

Use `myenv tools lookup` to find the correct name.

### Package Name Variations

Package names vary by ecosystem:

| Project | apt | pacman |
|---------|-----|--------|
| ripgrep | `rust-ripgrep` | `ripgrep` |
| fd-find | `fd-find` | `fd` |

The lockfile captures these mappings so the correct package is installed on each system.

### Filtering

We filter out auxiliary packages:
- `-doc`, `-docs` (documentation)
- `-git`, `-bin` (development/binary variants)
- `-dev`, `-devel`, `-dbg` (development files)
- `*-completion` (shell completions)

## Future Work

- [ ] Alias support (fd -> fd-find)
- [ ] Fallback to direct download for tools not in repos
- [ ] Historical version lookup via archive.org / ALA
- [ ] Hash verification for reproducibility
